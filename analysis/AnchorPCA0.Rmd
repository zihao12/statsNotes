---
title: "AnchorPCA0"
author: "zihao12"
date: "2021-05-27"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---


* Goal is try "AnchorPCA" : https://drive.google.com/file/d/1cmFQ9YV_5vptZD8m8IpQcljmfkmqKsj-/view?usp=sharing. The motivation is from anchor regression https://rss.onlinelibrary.wiley.com/doi/full/10.1111/rssb.12398
* Basic idea is, we observe matrix $Y \in R^{n \times p}$ and anchor variables $A \in R^{n \times L}$ (eacy to think of $A$ as encoding Batch ID), then to learn "useful" structure,  we can apply PCA to perturbed $\tilde{Y} = (I - \Pi_A) Y + \sqrt{\gamma} \Pi_A Y$, where $\Pi_A = A (A^T A)^{-1} A^T$ is projection onto the anchor subspace. So with $\tilde{Y} = X B + E$ we hope $X, B$ captures the useful structure. 
* I first run vanilla PCA on IRIS dataset, then create artificial batch effects. Then I try AnchorPCA with various $\gamma$. 
* The goal is proof of concept: I want to test for the extreme cases when $\gamma = 0, \infty$ makes sense. Next step is to find more realistic case where extropolation between the two extremes work better. 

```{r}
rm(list =ls())
set.seed(123)

perturb <- function(Y, A, gam){
  Y = as.matrix(Y)
  fit =lm(Y ~ A)
  Ytilde = sqrt(gam) * fit$fitted.values + fit$residuals
  return(Ytilde)
}
```



```{r}
data("iris")
n= nrow(iris)
df <- iris[sample(x = 1:n,size = n,replace = FALSE),]


fit.svd= svd(x = df[,1:4],nu = 2,nv = 2)
fit.svd$d
plot(fit.svd$u[,1], fit.svd$u[,2],col = df$Species)
```
There is clear structure to separate species. 


## Create artifical batch effect and try PCA
For each observation in IRIS, suppose we have an artificial batch effect

### Batch ID randomly assigned
In this case $a_i \in \{1,2,..., L\}$ is independent of $x_i$. Therefore it makes sense to partialize out the effect of $A$ on $Y$ first, which means centering by $Y_{ij} - \mu_{a_ij}$ first, then apply PCA. in the AnchorPCA framework, this corresponds to $\gamma = 0$. 

```{r}
par(mfrow = c(2,2))
df_ = df
df_[,"batch"] = sample(as.integer(df_$Species),size = n, replace = FALSE)
batch_shift = c(0, 0.5,1)
for(i in 1:3){
  l = sum(df_$batch == i)
  df_[df_$batch == i, 1:4] = df_[df_$batch == i, 1:4] + 
    rnorm(l*4,mean = batch_shift[i],sd = 1) 
}

## anchor PCA 
for(gam in c(10, 1, 0.3, 0)){
  Ytilde = perturb(Y = df_[,1:4], A = df_$batch,gam= gam)
  fit.svd= svd(x = Ytilde,nu = 4,nv = 4)
  fit.svd$d
  plot(fit.svd$u[,1], fit.svd$u[,2],col = df_$Species, main = sprintf("gam = %.2f", gam))
}
```
Indeed we can see with smaller $\gamma$, the biological structure seems clearer

### if the batch id is highly correlated with species 
* Just a proof of concept... it's cheating as batch id is just species id here. Here the role of $A$ is(?check) instrumental variable. 
* We can see removing supposedly "bacth effects" also remove useful biological information. 
```{r}
par(mfrow = c(2,2))
df_ = df
df_[,"batch"] = as.integer(df_$Species)
batch_shift = c(0, 0.5,1)
for(i in 1:3){
  l = sum(df_$batch == i)
  df_[df_$batch == i, 1:4] = df_[df_$batch == i, 1:4] +
    rnorm(l*4,mean = batch_shift[i],sd = 1)
}

## anchor PCA 
for(gam in c(10, 1, 0.3, 0)){
  Ytilde = perturb(Y = df_[,1:4], A = df_$batch,gam= gam)
  fit.svd= svd(x = Ytilde,nu = 4,nv = 4)
  fit.svd$d
  plot(fit.svd$u[,1], fit.svd$u[,2],col = df_$Species, main = sprintf("gam = %.2f", gam))
}

```


These two extreme cases show that indeed we might need to extroplate between $\gamma = 0$ and $\gamma = \infty$ to recover useful structure. 

